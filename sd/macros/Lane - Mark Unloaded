; param.A - This has been added to allow BtnCMD to call this macro for a specific lane

var lane_number = 0                                                                                     ; Initialize local variable for the lane number

if exists(param.A)                                                                                      ; Check if the lane number was passed as a parameter (e.g. from BtnCMD)
    set var.lane_number = param.A                                                                       ; Set the local variable to the passed parameter value
else
    M291 P"Select the lane to be measured" K{global.M291_lane_list} S4 J1                               ; Display popup for manual lane selection
    set var.lane_number=input                                                                           ; Store the user's selection in the local variable

if global.AFC_lane_loaded[{var.lane_number}]                                                            ; Check if the selected lane is currently marked as 'Loaded' in globals
    set global.AFC_lane_loaded[{var.lane_number}] = false                                               ; Update global status to 'Unloaded' (False)
    echo >"0:/sys/AFC/AFC-info/lane_status.g" " ; lane status"                                          ; Overwrite/Initialize the persistence file
    echo >>"0:/sys/AFC/AFC-info/lane_status.g" "set global.AFC_lane_loaded = " ^ global.AFC_lane_loaded ; Append the updated global array to the file for persistence
    set global.AFC_LED_array[{var.lane_number}] = 0                                                     ; Update LED status array to 0 (Red/Empty)
    M98 P"0:/sys/AFC/LEDs.g"                                                                            ; Execute the LED macro to update the physical lights
else
    M118 S{"Lane "^{var.lane_number}^" is not marked as loaded"}                                        ; Send message to console if lane was already unloaded