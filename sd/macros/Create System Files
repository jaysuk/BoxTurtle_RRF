; ############## Auto-Setup: File Generator #############
; This script automatically generates the necessary system files (tpre, tpost, triggers, etc.)
; based on the user's AFC configuration. It allows the user to select specific files or generate all at once.

var filename = " " ; Variable to store the name of the file currently being created
var choice=0       ; Variable to store the user's menu selection

; --- User Menu ---
; Prompt the user to select which group of files to generate.
; Options range from "All" (0) to specific categories like Triggers (4) or cleanup (7).
M291 P"Select the files to be created" K{"All","Tpre","Tpost","Tfree","Triggers","Homing File","Filament Errors","Rename Unused Files"} S4 J1
set var.choice=input

; --- 1. Generate tpre.g (Tool Pre-Change) ---
if var.choice == 0 || var.choice == 1
    set var.filename = "tpre.g"
    echo >{var.filename} "; autogenerated tpre.g file" ; Create/Overwrite file
    ; Write command to call the central AFC tpre macro, passing the *next* tool index
    echo >>{var.filename} "M98 P""0:/sys/AFC/tpre.g"" A{state.nextTool}"

; --- 2. Generate tpost.g (Tool Post-Change) ---
if var.choice == 0 || var.choice == 2
    set var.filename = "tpost.g"
    echo >{var.filename} "; autogenerated tpost.g file" ; Create/Overwrite file
    ; Write command to call the central AFC tpost macro, passing the *current* tool index
    echo >>{var.filename} "M98 P""0:/sys/AFC/tpost.g"" A{state.currentTool}"

; --- 3. Generate tfree.g (Tool Free/Unload) ---
if var.choice == 0 || var.choice == 3
    set var.filename = "tfree.g"
    echo >{var.filename} "; autogenerated tfree.g file" ; Create/Overwrite file
    ; Write logic to check if DC motor feature is enabled
    echo >>{var.filename} "if global.AFC_features[8]"
    ; If enabled, call tfree with B1 (DC Motor On)
    echo >>{var.filename} "    M98 P""0:/sys/AFC/tfree.g"" A{state.currentTool} B1"
    echo >>{var.filename} "else"
    ; If disabled, call tfree with B0 (DC Motor Off)
    echo >>{var.filename} "    M98 P""0:/sys/AFC/tfree.g"" A{state.currentTool} B0"
    echo >>{var.filename} "M400"

; --- 4. Generate Trigger Files ---
if var.choice == 0 || var.choice == 4
    ; Loop through all lanes to create basic trigger files (e.g., for filament runout/presence)
    while iterations < global.AFC_total_lanes
        set var.filename = "trigger"^{global.AFC_trigger_numbers[iterations]}^".g"
        echo >{var.filename} "; autogenerated trigger"^global.AFC_trigger_numbers[iterations]^".g file"
        echo >>{var.filename} "M98 P""0:/sys/AFC/AFC_triggers.g"" A"^{iterations}

    ; --- Buffer Trigger 0 (Advance/Too Much Filament) ---
    ; Creates the trigger file defined in config for buffer overflow state
    set var.filename = "trigger"^{global.AFC_buffer_trigger_numbers[0]}^".g"
    echo >{var.filename} "; autogenerated trigger"^global.AFC_buffer_trigger_numbers[0]^".g file"
    echo >>{var.filename} "; This trigger is called once a print has been initiated if the buffer flags"
    echo >>{var.filename} "; that the filament in the bowden is more than is needed by the printer"
    echo >>{var.filename} "; the mixing ratio is then adjusted so 5% less filament is fed from the lane than requested"
    echo >>{var.filename} " "
    ; Write logic to reduce flow ratio (0.95) for specific tools to tighten the loop
    while iterations < global.AFC_total_lanes
        echo >>{var.filename} "if state.currentTool = "^iterations
        echo >>{var.filename} "    M567 P"^iterations^" E1:0.95"

    ; --- Buffer Trigger 1 (Trail/Too Little Filament) ---
    ; Creates the trigger file defined in config for buffer underflow state
    set var.filename = "trigger"^{global.AFC_buffer_trigger_numbers[1]}^".g"
    echo >{var.filename} "; autogenerated trigger"^global.AFC_buffer_trigger_numbers[1]^".g file"
    echo >>{var.filename} "; This trigger is called once a print has been initiated if the buffer flags"
    echo >>{var.filename} "; that the filament in the bowden is less than is needed by the printer"
    echo >>{var.filename} "; the mixing ratio is then adjusted so 5% more filament is fed from the lane than requested"
    echo >>{var.filename} " "
    ; Write logic to increase flow ratio (1.05) for specific tools to loosen the loop
    while iterations < global.AFC_total_lanes
        echo >>{var.filename} "if state.currentTool = "^iterations
        echo >>{var.filename} "    M567 P"^iterations^" E1:1.05"

; --- 5. Generate Homing File ---
if var.choice == 0 || var.choice == 5
    ; Note: ''f escapes the single quote to create axis 'f' in the output file
    echo >"home''f.g" "; autogenerated home''f.g file"
    echo >>"home''f.g" "G1 H1 ''f500 F"^{global.AFC_load_retract_speed[0]*60} ; Write homing move
    echo >>"home''f.g" "G92 ''f0" ; Write position reset

; --- 6. Generate Filament Error File ---
if var.choice == 0 || var.choice == 6
    set var.filename = "filament-error1.g"
    echo >{var.filename} "; autogenerated filament-error1.g file"
    echo >>{var.filename} "var tool_number = state.currentTool"
    ; Redirect to the main AFC error handling macro
    echo >>{var.filename} "M98 P""0:/sys/AFC/filament-error.g"" A{var.tool_number}"

; --- 7. Rename/Backup Unused Files ---
; This prevents conflicts between specific tool files (like tpre0.g) and the generic generated files (tpre.g)
if var.choice == 0 || var.choice == 7
    if fileexists("0:/sys/tpre0.g")
        M471 S"0:/sys/tpre0.g" T"0:/sys/tpre0.unused" ; Rename tpre0.g -> tpre0.unused
    if fileexists("0:/sys/tpost0.g")
        M471 S"0:/sys/tpost0.g" T"0:/sys/tpost0.unused" ; Rename tpost0.g -> tpost0.unused
    if fileexists("0:/sys/tfree0.g")
        M471 S"0:/sys/tfree0.g" T"0:/sys/tfree0.unused" ; Rename tfree0.g -> tfree0.unused