; param.A - This has been added to allow BtnCMD to call this macro for a specific lane

; AFC Feature Numbers
; 0 = brush
; 1 = cut
; 2 = kick
; 3 = park
; 4 = poop
; 5 = purge
; 6 = load
; 7 = startup check
; 8 = use the dc motor on unload
; 9 = unload method
; 10 = spoolman support

var lane_number = 0                                                          ; Initialize local variable for the lane number

if exists(param.A)                                                           ; Check if the lane number parameter exists (e.g. passed from BtnCMD)
    set var.lane_number = param.A                                            ; Set local variable to the passed parameter value
else 
    M291 P"Select the lane use to unload" K{global.M291_lane_list_all} S4 J1 ; Display popup dialog for manual lane selection
    set var.lane_number=input                                                ; Store the user selection in the local variable

if var.lane_number != global.AFC_total_lanes
    if global.AFC_features[8]                                                ; Check if Feature 8 (DC Motor on Unload) is enabled
        M98 P"0:/sys/AFC/unload.g" A{var.lane_number} B1                     ; Execute unload macro for selected lane with DC motor enabled (B1)
    else
        M98 P"0:/sys/AFC/unload.g" A{var.lane_number} B0                     ; Execute unload macro for selected lane with DC motor disabled (B0)
else
    while iterations < global.AFC_total_lanes
        if global.AFC_features[8]                                            ; Check if Feature 8 (DC Motor on Unload) is enabled
            M98 P"0:/sys/AFC/unload.g" A{iterations} B1                      ; Execute unload macro for selected lane with DC motor enabled (B1)
        else
            M98 P"0:/sys/AFC/unload.g" A{iterations} B0                      ; Execute unload macro for selected lane with DC motor disabled (B0)